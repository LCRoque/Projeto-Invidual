<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <title>CR7 FORUM | Página Incial</title>
    <link rel="stylesheet" href="css/styledashboard.css">
    <link href='https://unpkg.com/boxicons@2.0.7/css/boxicons.min.css' rel='stylesheet'>
    <link rel="shortcut icon" type="imagex/png" href="css/imagens/cr7logo.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="../js/sessao.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div class="sidebar">
    <div class="logo">
        <i class='bx bxl-c-plus-plus'></i>
        <img src="css/imagens/cr7logosemfundo.png" alt="">
    </div>
    <ul class="nav-links">
        <li>
            <a href="indexdash.html">
                <i class='bx bx-grid-alt'></i>
                <span class="link_name">Notícias</span>
            </a>
        </li>
        <li>
            <div class="iocn-link">
                <a href="publicarnoticia.html">
                    <i class='bx bx-book-alt'></i>
                    <span class="link_name">Postar Notícia</span>
                </a>
            </div>
        </li>
        <li>
            <a href="#">
                <i class='bx bx-line-chart'></i>
                <span class="link_name">Estátisticas Fórum</span>
            </a>
        </li>
        <li>
            <a href="cruzadinha.html">
                <i class='bx bxs-notepad'></i>
                <span class="link_name">Cruzadinha</span>
            </a>
        </li>
        <li>
            <div class="profiledetalhes">
                <i class='bx bx-log-out' onclick="limparSessao()"></i>
            </div>
        </li>
    </ul>
</div>
<section class="home">
    <div class="home-content">
        <i class='bx bx-menu'></i>
        <span class="text">Acompanhe nossa comunidade!</span>
    </div>
    <div id="graficos"></div>
    <div id="graficos2"></div>
</section>
<script src="js/scriptmenudash.js"></script>
<script>
let proximaAtualizacao;
let myChart;
let myChart2;

window.onload = exibirUsuarios;

function exibirUsuarios() {
    document.getElementById("graficos").innerHTML = `
        <div id="grafico">
            <h3 class="tituloGraficos">
                <span id="tituloGrafico"></span>
            </h3>
            <div class="graph">
                <canvas id="myChartCanvas"></canvas>
                <div class="label-captura">
                <p id="avisoCaptura" style="color: black">Acompanhe Simultâneamente nosso Fórum crescendo!</p>
            </div>
            </div>
            
        </div>
    `;

    document.getElementById("graficos2").innerHTML = `
        <div id="grafico2">
            <div class="graph2">
                <canvas id="myChartCanvas2"></canvas>
                <div class="label-captura2">
                <p id="avisoCaptura" style="color: black">Acompanhe a quantidade de publicações do nosso Fórum!</p>
            </div>
            </div>
        </div>
    `;

    obterDadosGrafico();
}

function obterDadosGrafico() {
    if (proximaAtualizacao != undefined) {
        clearTimeout(proximaAtualizacao);
    }

    fetch(`/medidas/ultimas/`, { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
            response.json().then(function (resposta) {
                console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                plotarGrafico(resposta);
            });
        } else {
            console.error('Nenhum dado encontrado ou erro na API');
        }
    })
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados para o gráfico: ${error.message}`);
    });

    fetch(`/medidas/ultimasn/`, { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
            response.json().then(function (resposta) {
                console.log(`Dados recebidos: ${JSON.stringify(resposta)}`);
                plotarGrafico2(resposta);
            });
        } else {
            console.error('Nenhum dado encontrado ou erro na API');
        }
    })
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados para o gráfico: ${error.message}`);
    });
}

function plotarGrafico(resposta) {
    console.log('Iniciando plotagem do gráfico...');

    let labels = ["Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

    let dados = {
        labels: labels,
        datasets: [{
            label: 'Total de Pessoas no Fórum',
            data: [resposta[0].quantidade_usuarios],
            backgroundColor: 'rgb(0, 0, 0)',
            borderColor: 'rgb(0, 0, 0)',
            borderWidth: 1
        }]
    };

    const config = {
        type: 'bar',
        data: dados,
    };

    // Destruir gráfico existente antes de criar um novo
    if (myChart) {
        myChart.destroy();
    }

    myChart = new Chart(
        document.getElementById('myChartCanvas'),
        config
    );
}
  
function plotarGrafico2(resposta) {
    let labels2 = ["Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];

    let dados2 = {
        labels: labels2,
        datasets: [{
            label: 'Notícias no Fórum',
            data: [resposta[0].quantidade_noticias],
            backgroundColor: 'rgb(0, 0, 0)',
            borderColor: 'rgb(0, 0, 0)',
            borderWidth: 1
        }]
    };

    const config2 = {
        type: 'bar',
        data: dados2,
    };

    if (myChart2) {
        myChart2.destroy();
    }

    myChart2 = new Chart(
        document.getElementById('myChartCanvas2'),
        config2
    );

    setTimeout(() => atualizarGrafico(dados2, myChart2), 5000);
}

function atualizarGrafico(dados, chartInstance) {
    fetch(`/medidas/tempo-real/`, { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
            response.json().then(function (novoRegistro) {
                console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                dados.datasets[0].data[0] = novoRegistro[0].quantidade_usuarios;
                chartInstance.update();
            });
        } else {
            console.error('Nenhum dado encontrado ou erro na API');
        }
    })
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados para o gráfico: ${error.message}`);
    });

    fetch(`/medidas/tempo-realn/`, { cache: 'no-store' }).then(function (response) {
        if (response.ok) {
            response.json().then(function (novoRegistro) {
                console.log(`Dados recebidos: ${JSON.stringify(novoRegistro)}`);
                dados.datasets[0].data[0] = novoRegistro[0].quantidade_noticias;
                chartInstance.update();
                proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, chartInstance), 5000);
            });
        } else {
            console.error('Nenhum dado encontrado ou erro na API');
            proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, chartInstance), 5000);
        }
    })
    .catch(function (error) {
        console.error(`Erro na obtenção dos dados para o gráfico: ${error.message}`);
        proximaAtualizacao = setTimeout(() => atualizarGrafico(dados, chartInstance), 5000);
    });
}
</script>
</body>
</html>
